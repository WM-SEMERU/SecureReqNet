---

title: Testing âœ…


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/10_deployment.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/10_deployment.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>[nltk_data] Downloading package stopwords to /home/roger/nltk_data...
[nltk_data]   Package stopwords is already up-to-date!
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Backend-Service">Backend Service<a class="anchor-link" href="#Backend-Service"> </a></h2><p>These methods ping the TFX serving endpoint and get predictions from the model.  The input of the served model would be vectorized sentences in tensor form and the output is the output of the final FC layer</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="__get_predictions" class="doc_header"><code>__get_predictions</code><a href="https://github.com/rmclanton/SecureReqNet/blob/master/securereqnet/deployment.py#L19" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>__get_predictions</code>(<strong><code>sentences</code></strong>, <strong><code>endpoint_uri</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="__decode" class="doc_header"><code>__decode</code><a href="https://github.com/rmclanton/SecureReqNet/blob/master/securereqnet/deployment.py#L46" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>__decode</code>(<strong><code>input</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Flask-Backend">Flask Backend<a class="anchor-link" href="#Flask-Backend"> </a></h2><p>Defines a factory for our app.  Serving is packaged nicely inside a serve method, and is ready to deploy with waitress.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="create_app" class="doc_header"><code>create_app</code><a href="https://github.com/rmclanton/SecureReqNet/blob/master/securereqnet/deployment.py#L51" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>create_app</code>(<strong><code>test_config</code></strong>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="serve" class="doc_header"><code>serve</code><a href="waitress.py#L5" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>serve</code>(<strong><code>app</code></strong>, <strong>**<code>kw</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">securereqnet</span>
<span class="nb">dir</span><span class="p">(</span><span class="n">securereqnet</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39;__builtins__&#39;,
 &#39;__cached__&#39;,
 &#39;__doc__&#39;,
 &#39;__file__&#39;,
 &#39;__loader__&#39;,
 &#39;__name__&#39;,
 &#39;__package__&#39;,
 &#39;__path__&#39;,
 &#39;__spec__&#39;,
 &#39;__version__&#39;,
 &#39;preprocessing&#39;,
 &#39;utils&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">unittest.mock</span>
<span class="kn">from</span> <span class="nn">unittest</span> <span class="kn">import</span> <span class="n">mock</span>
<span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>
<span class="kn">from</span> <span class="nn">securereqnet.deployment</span> <span class="kn">import</span> <span class="n">create_app</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">({</span><span class="s1">&#39;TESTING&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;TFX_ENDPOINT&quot;</span><span class="p">:</span> <span class="s2">&quot;MockMockMock&quot;</span><span class="p">})</span>
<span class="n">test_client</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Succeeds if the response code for default path is 200</span>
<span class="k">def</span> <span class="nf">test_app_homepage</span><span class="p">():</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">test_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="o">==</span><span class="mi">200</span>

<span class="n">test_app_homepage</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Mock the backend request to TFX serving</span>
<span class="c1"># Succeeds if data returns successfully in correct form</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;securereqnet.deployment.__get_predictions&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_get_prediction_single</span><span class="p">(</span><span class="n">mock_predictions</span><span class="p">):</span>
    <span class="n">test_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;instances&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;test test test test&quot;</span><span class="p">]}</span>
    <span class="n">expected_pred</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;predictions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">True</span><span class="p">]}</span>
    <span class="n">mock_predictions</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">expected_pred</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">test_client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/models/alpha&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">test_payload</span><span class="p">)</span>
    <span class="n">r_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">r_data</span> <span class="o">==</span> <span class="n">expected_pred</span>

<span class="n">test_get_prediction_single</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[&#39;test test test test&#39;]
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Mock the backend request to TFX serving</span>
<span class="c1"># Succeeds if data returns successfully in correct form</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;securereqnet.deployment.__get_predictions&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_get_prediction_multi</span><span class="p">(</span><span class="n">mock_predictions</span><span class="p">):</span>
    <span class="n">test_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;instances&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;test test test test&quot;</span><span class="p">,</span> <span class="s2">&quot;more testing&quot;</span><span class="p">,</span> <span class="s2">&quot;super duper testing&quot;</span><span class="p">]}</span>
    <span class="n">expected_pred</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;predictions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]}</span>
    <span class="n">mock_predictions</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">expected_pred</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">test_client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/models/alpha&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">test_payload</span><span class="p">)</span>
    <span class="n">r_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">r_data</span> <span class="o">==</span> <span class="n">expected_pred</span>

<span class="n">test_get_prediction_multi</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[&#39;test test test test&#39;, &#39;more testing&#39;, &#39;super duper testing&#39;]
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Backend-Service">Backend Service<a class="anchor-link" href="#Backend-Service"> </a></h2>
</div>
</div>
</div>
</div>
 

